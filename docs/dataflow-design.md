# Focus Habit Frontend - 데이터 플로우 설계

## 개요
웹캠/마이크/웨어러블 → 데이터 수집 → AI 모델 → 실시간 집중도·행동 분류 → UI 반영 + 리포트 저장의 전체 데이터 플로우를 설계합니다.

## 전체 데이터 플로우 구조

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              데이터 수집 레이어                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  웹캠 스트림    │    마이크 스트림    │    웨어러블 센서    │    사용자 행동      │
│  (10fps)       │    (실시간)        │    (선택적)        │    (마우스/키보드)   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              실시간 처리 파이프라인                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  WebSocket      │    Audio Pipeline │    Gesture Recognition │    Behavior Track │
│  (프레임 전송)   │    (음성 분석)    │    (제스처 인식)      │    (활동 감지)     │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AI 모델 분석 레이어                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  GPT-4o-mini    │    Computer Vision│    Audio Analysis     │    ML Engine      │
│  (발화분석)     │    (시선/자세)    │    (음성 패턴)        │    (집중도 계산)   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              데이터 저장 및 동기화                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Supabase       │    Real-time      │    Local Cache        │    Session Store  │
│  (PostgreSQL)   │    (WebSocket)    │    (React Query)      │    (Zustand)      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              UI 반영 및 리포트                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  실시간 차트     │    대시보드       │    리포트 생성        │    소셜 기능       │
│  (Recharts)     │    (Dashboard)    │    (ReportService)    │    (Study Room)   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 1. 데이터 수집 레이어

### 1.1 웹캠 스트림 (10fps)
- **수집 주기**: 1초에 10번 (10fps)
- **수집 데이터**:
  - 프레임 이미지 (JPEG Base64)
  - 눈 상태 (열림/닫힘)
  - 머리 자세 (pitch, yaw, roll)
  - 시선 방향
  - EAR 값 (Eye Aspect Ratio)

### 1.2 마이크 스트림 (실시간)
- **수집 주기**: 실시간
- **수집 데이터**:
  - 오디오 레벨 (RMS dB)
  - 음성 인식 텍스트
  - 발화 지속시간
  - 음성 패턴 분석

### 1.3 웨어러블 센서 (선택적)
- **수집 주기**: 5초마다
- **수집 데이터**:
  - 심박수 (Heart Rate)
  - 걸음 수 (Steps)
  - 활동량 (Activity Level)
  - 스트레스 레벨 (Stress Level)
  - 자세 (Posture)
  - 움직임 (Movement)

### 1.4 사용자 행동 감지
- **수집 주기**: 이벤트 기반
- **수집 데이터**:
  - 마우스 활동
  - 키보드 활동
  - 탭 전환 횟수
  - 유휴 시간

## 2. 실시간 처리 파이프라인

### 2.1 WebSocket 프레임 전송
- **전송 방식**: Base64 인코딩된 JPEG 이미지
- **압축**: 적응형 JPEG 품질 (네트워크 상태에 따라 조정)
- **대상 서버**: `wss://focushabit.site/ws/analysis`

### 2.2 Audio Pipeline
- **음성 인식**: Web Speech API
- **텍스트 버퍼링**: 일정 길이 쌓이면 분석
- **GPT 분석**: `/api/classify-speech` 엔드포인트

### 2.3 Gesture Recognition
- **분석 서버**: WebSocket 기반 실시간 분석
- **반환 데이터**: 제스처, 집중 상태, 신뢰도

### 2.4 Behavior Tracking
- **활동 감지**: 마우스/키보드 이벤트 리스너
- **유휴 감지**: 일정 시간 활동 없음 감지

## 3. AI 모델 분석 레이어

### 3.1 GPT-4o-mini 발화분석
- **모델**: GPT-4o-mini
- **분석 결과**:
  - 공부 관련성 판단 (study/no_study)
  - 신뢰도 점수 (0.0-1.0)
  - 문맥 분석

### 3.2 Computer Vision 분석
- **분석 항목**:
  - 눈 상태 (열림/닫힘/부분)
  - 머리 자세 (pitch, yaw, roll)
  - 집중도 예측 (0-1 범위)
  - 신뢰도 점수

### 3.3 서버 기반 집중도 계산
- **서버 분석**: WebSocket을 통해 실시간 집중도 점수 계산
- **반환 데이터**: 
  - 집중도 점수 (0-100 범위)
  - 신뢰도 점수 (0.0-1.0)
  - 분석 메타데이터
- **클라이언트**: 서버에서 받은 점수를 바로 사용

## 4. 데이터 저장 및 동기화

### 4.1 Supabase 데이터베이스
- **focus_session**: 집중 세션 정보
- **focus_sample**: 집중도 샘플 데이터
- **focus_event**: 집중 관련 이벤트
- **ml_features**: ML 분석 피쳐값

### 4.2 실시간 동기화
- **Supabase Realtime**: 실시간 데이터베이스 변경 감지
- **WebSocket**: 실시간 UI 업데이트

### 4.3 로컬 캐시
- **React Query**: 서버 데이터 캐싱 (5분 stale time)
- **Zustand**: 클라이언트 상태 관리
- **IndexedDB**: 대용량 데이터 로컬 저장

## 5. UI 반영 및 리포트

### 5.1 실시간 차트
- **Recharts**: 실시간 집중도 차트
- **CircularGauge**: 현재 집중도 게이지
- **PulseIndicator**: 실시간 상태 표시

### 5.2 대시보드
- **Dashboard**: 종합 집중도 대시보드
- **Session Controls**: 세션 시작/중지/일시정지
- **Error Display**: 오류 상태 표시

### 5.3 리포트 생성
- **Daily Report**: 일일 집중도 리포트
- **Weekly Report**: 주간 집중도 리포트
- **Session Report**: 개별 세션 리포트

### 5.4 소셜 기능
- **Study Room**: 실시간 스터디룸
- **Group Challenge**: 그룹 챌린지
- **Friend Ranking**: 친구 랭킹

## 6. 데이터 플로우 시퀀스

### 6.1 세션 시작 시
1. 사용자가 "세션 시작" 버튼 클릭
2. `focus_session` 테이블에 새 레코드 생성
3. 웹캠, 마이크 권한 요청 및 스트림 시작
4. WebSocket 연결 (실시간 분석 서버)
5. UI 상태를 "실행 중"으로 변경

### 6.2 실시간 데이터 처리
1. 웹캠 프레임 캡처 (10fps)
2. Base64 인코딩 후 WebSocket으로 전송
3. 서버에서 Computer Vision 모델로 분석
4. 서버에서 집중도 점수 계산 (0-100 범위)
5. 분석 결과를 WebSocket으로 수신 (`prediction_result`)
6. 클라이언트에서 받은 점수를 바로 사용
7. `focus_sample` 테이블에 저장
8. 실시간 차트 및 게이지 업데이트

### 6.3 음성 분석 처리
1. Web Speech API로 실시간 음성 인식
2. 텍스트 버퍼링 (일정 길이 쌓이면)
3. GPT API로 공부 관련성 판단
4. `focus_event` 테이블에 이벤트 저장
5. 집중도 계산에 음성 분석 결과 반영

### 6.4 세션 종료 시
1. 사용자가 "세션 종료" 버튼 클릭
2. `focus_session` 테이블에 종료 시간 기록
3. 일일 요약 데이터 업데이트
4. 스터디룸 자동 챌린지 진행사항 업데이트
5. 세션 종료 알림 및 결과 표시

## 7. 성능 최적화

### 7.1 네트워크 최적화
- 적응형 압축: 네트워크 상태에 따른 JPEG 품질 조정
- 배치 전송: 여러 프레임을 묶어서 전송
- 연결 풀링: WebSocket 연결 재사용

### 7.2 메모리 관리
- 프레임 버퍼 제한: 최대 100개 프레임만 메모리에 유지
- 가비지 컬렉션: 주기적인 메모리 정리
- 이벤트 디바운싱: 과도한 이벤트 발생 방지

### 7.3 캐싱 전략
- React Query: 서버 데이터 캐싱 (5분 stale time)
- Zustand: 클라이언트 상태 영속화
- IndexedDB: 대용량 데이터 로컬 저장

## 8. 에러 처리 및 복구

### 8.1 연결 실패 처리
- WebSocket 연결 실패 시 자동 재연결
- GPT API 실패 시 키워드 기반 분석으로 폴백
- 웹캠 실패 시 마이크만으로 집중도 분석

### 8.2 데이터 무결성
- 중복 방지: 동일한 타임스탬프 데이터 중복 저장 방지
- 데이터 검증: 저장 전 데이터 형식 및 범위 검증
- 백업 전략: 중요 데이터의 로컬 백업

## 9. 확장성 고려사항

### 9.1 마이크로서비스 아키텍처
- 분석 서버: 독립적인 AI 분석 서버
- 실시간 서버: WebSocket 전용 서버
- API 서버: REST API 전용 서버

### 9.2 데이터 파이프라인
- Apache Kafka: 대용량 실시간 데이터 스트리밍
- Redis: 실시간 캐싱 및 세션 관리
- Elasticsearch: 로그 분석 및 검색

### 9.3 모니터링 및 로깅
- Prometheus: 메트릭 수집
- Grafana: 대시보드 시각화
- ELK Stack: 로그 분석

이 데이터 플로우 설계를 통해 실시간 집중도 분석, AI 기반 행동 분류, 그리고 종합적인 리포트 시스템을 효율적으로 구현할 수 있습니다.
